<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gerenciador de Tarefas</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        td[contenteditable="true"] { background-color: #f9f9f9; }
    </style>
</head>
<body>

<h2>Tabela de tarefas</h2>
<a href="/logout">Sair</a>

<h3>Tarefas</h3>

<table>
    <thead>
        <tr>
            <th>Selecionar</th>
            <th>Descrição</th>
            <th>Status</th>
            <th>Data</th>
            <th>Responsável</th>
            <th>Observações</th>
            <th>PDF</th>
        </tr>
    </thead>
    <tbody>
    {% for tarefa in tarefas %}
    <tr>
        <td>
            <input type="checkbox">
        </td>

        <td>
            <input type="text"
                value="{{ tarefa.Descrição or '' }}"
                data-id="{{ tarefa.ID }}"
                data-coluna="Descrição">
        </td>

        <td>
            <input type="text"
                value="{{ tarefa.Status or '' }}"
                data-id="{{ tarefa.ID }}"
                data-coluna="Status">
        </td>

        <td>
            <input type="date"
                value="{{ tarefa.Data or '' }}"
                data-id="{{ tarefa.ID }}"
                data-coluna="Data">
        </td>

        <td>
            <input type="text"
                value="{{ tarefa.Responsável or '' }}"
                data-id="{{ tarefa.ID }}"
                data-coluna="Responsável">
        </td>

        <td>
            <input type="text"
                value="{{ tarefa.Observações or '' }}"
                data-id="{{ tarefa.ID }}"
                data-coluna="Observações">
        </td>

        <td>
            {% if tarefa.PDF %}
                <a href="{{ tarefa.PDF }}" target="_blank">
                    {{ tarefa.PDF.split('/')[-1] }}
                </a>
                <br>
            {% endif %}

            <input type="file"
                data-id="{{ tarefa.ID }}"
                onchange="uploadPDF(this)">
        </td>
    </tr>
    {% endfor %}
    </tbody>

</table>

<script>
document.addEventListener("keydown", function (e) {
    if (e.target.tagName !== "INPUT") return;

    const input = e.target;

    if (e.key === "Enter") {
        e.preventDefault();
        salvarCelula(input);
        moverParaDireita(input);
    }
});

document.addEventListener("blur", function (e) {
    if (e.target.tagName !== "INPUT") return;

    salvarCelula(e.target);
}, true);


function salvarCelula(input) {
    const id = input.dataset.id;
    const coluna = input.dataset.coluna;
    const valor = input.value;

    if (!id || !coluna) return;

    fetch("/atualizar-celula", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            id: Number(id),
            coluna: coluna,
            valor: valor
        })
    })
    .then(() => {
        input.style.backgroundColor = "#d4f8d4"; 
        setTimeout(()=>{ 
            input.style.backgroundColor = "";},600); 
    });
}

document.addEventListener("focus", function (e) {
    if (e.target.tagName === "INPUT") {
        e.target.dataset.original = e.target.value;
    }
}, true);

document.addEventListener("blur", function (e) {
    if (e.target.tagName !== "INPUT") return;
     if (e.target.type === "file") return;

    if (e.target.dataset.original !== e.target.value) {
        salvarCelula(e.target);
    }
}, true);


function moverParaDireita(input) {
    const td = input.closest("td");
    const tr = td.parentElement;
    const tds = Array.from(tr.children);
    const indexAtual = tds.indexOf(td);
    const proximoTd = tds[indexAtual + 1];

    if (proximoTd){
        const proximoInput = proximoTd.querySelector("input");
        if (proximoInput) {
            proximoInput.focus();
            return;
        }
    }
    const proximaLinha = tr.nextElementSibling;
    if (!proximaLinha) return;

    const primeiroInput = proximaLinha.querySelector('input:not([type="checkbox"])')
    
    if (primeiroInput) {
        primeiroInput.focus();
    }
}

function uploadPDF(input) {
    const id = input.dataset.id;
    const file = input.files[0];
    if (!file || !id) return;

    const formData = new FormData();
    formData.append("file", file);
    formData.append("id", id);

    fetch("/upload-pdf", {
        method: "POST",
        body: formData
    })
    .then(res => {
        if (!res.ok) throw new Error("Falha no upload");
        return res.json();
    })
    .then(() => {
        const td = input.closest("td");

        // remove link antigo (se existir)
        const oldLink = td.querySelector("a");
        if (oldLink) oldLink.remove();

        // cria novo link
        const link = document.createElement("a");
        link.href = "#"; // será atualizado ao recarregar
        link.textContent = file.name;
        link.target = "_blank";

        td.insertBefore(link, input);
        td.insertBefore(document.createElement("br"), input);

        alert("PDF enviado com sucesso");
    })
    .catch(err => {
        alert("Erro ao enviar PDF");
        console.error(err);
    });
}

</script>

</body>
</html>

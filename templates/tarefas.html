<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gerenciador de Tarefas</title>
    <style>
    body { font-family: Arial, sans-serif; margin: 20px; }

    table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
    }

    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
        vertical-align: middle;
    }

    th {
        background-color: #f2f2f2;
    }

    /* botão falso de upload */
    .btn-upload {
        display: inline-block;
        padding: 4px 10px;
        margin-left: 10px;
        background: #eee;
        border: 1px solid #ccc;
        cursor: pointer;
        font-size: 14px;
        border-radius: 4px;
    }

    .btn-upload:hover {
        background: #ddd;
    }

    /* link do PDF */
    .pdf-link {
        margin-right: 8px;
        color: blue;
        text-decoration: underline;
        cursor: pointer;
    }
</style>
</head>
<body>

<h2>Tabela de tarefas</h2>
<a href="/logout">Sair</a>

<h3>Tarefas</h3>

<table>
    <thead>
        <tr>
            <th>Selecionar</th>
            <th>Descrição</th>
            <th>Status</th>
            <th>Data</th>
            <th>Responsável</th>
            <th>Observações</th>
            <th>PDF</th>
        </tr>
    </thead>
    <tbody>
    {% for tarefa in tarefas %}
    <tr>
        <td>
            <input type="checkbox">
        </td>

        <td>
            <input type="text"
                value="{{ tarefa.Descrição or '' }}"
                data-id="{{ tarefa.ID }}"
                data-coluna="Descrição">
        </td>

        <td>
            <input type="text"
                value="{{ tarefa.Status or '' }}"
                data-id="{{ tarefa.ID }}"
                data-coluna="Status">
        </td>

        <td>
            <input type="date"
                value="{{ tarefa.Data or '' }}"
                data-id="{{ tarefa.ID }}"
                data-coluna="Data">
        </td>

        <td>
            <input type="text"
                value="{{ tarefa.Responsável or '' }}"
                data-id="{{ tarefa.ID }}"
                data-coluna="Responsável">
        </td>

        <td>
            <input type="text"
                value="{{ tarefa.Observações or '' }}"
                data-id="{{ tarefa.ID }}"
                data-coluna="Observações">
        </td>

        <td>
            {% if tarefa.PDF %}
                <a href="{{ tarefa.PDF }}" target="_blank" class="pdf-link"> {{ tarefa.PDF.split('/')[-1] }}
                </a>
            {% else %}
                <span class="pdf-link">Nenhum arquivo</span>
            {% endif %}

            <label class="btn-upload">
                Escolher arquivo
            <input type="file"
                data-id="{{ tarefa.ID }}"
                onchange="uploadPDF(this)"
                hidden>
            </label>
        </td>
    </tr>
    {% endfor %}

    <tr class="linha-nova">
        <td><input type="checkbox"></td>

        <td><input type="text" data-coluna="Descrição"></td>
        <td><input type="text" data-coluna="Status"></td>
        <td><input type="date" data-coluna="Data"></td>
        <td><input type="text" data-coluna="Responsável"></td>
        <td><input type="text" data-coluna="Observações"></td>
        <td>
            <input type="file">
        </td>
    </tr>


    </tbody>

</table>

<script>
document.addEventListener("keydown", function (e) {
    if (e.target.tagName !== "INPUT") return;

    const input = e.target;

    if (e.key === "Enter") {
        e.preventDefault();
        salvarCelula(input);
        moverParaDireita(input);
    }
});

document.addEventListener("blur", function (e) {
    if (e.target.tagName !== "INPUT") return;

    salvarCelula(e.target);
}, true);


function salvarCelula(input) {
    const id = input.dataset.id;
    const coluna = input.dataset.coluna;
    const valor = input.value;

    if (!id || !coluna) return;

    fetch("/atualizar-celula", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            id: Number(id),
            coluna: coluna,
            valor: valor
        })
    })
    .then(() => {
        input.style.backgroundColor = "#d4f8d4"; 
        setTimeout(()=>{ 
            input.style.backgroundColor = "";},600); 
    });
}

document.addEventListener("focus", function (e) {
    if (e.target.tagName === "INPUT") {
        e.target.dataset.original = e.target.value;
    }
}, true);

document.addEventListener("blur", function (e) {
    if (e.target.tagName !== "INPUT") return;
     if (e.target.type === "file") return;

    if (e.target.dataset.original !== e.target.value) {
        salvarCelula(e.target);
    }
}, true);


function moverParaDireita(input) {
    const td = input.closest("td");
    const tr = td.parentElement;
    const tds = Array.from(tr.children);
    const indexAtual = tds.indexOf(td);
    const proximoTd = tds[indexAtual + 1];

    if (proximoTd){
        const proximoInput = proximoTd.querySelector("input");
        if (proximoInput) {
            proximoInput.focus();
            return;
        }
    }
    const proximaLinha = tr.nextElementSibling;
    if (!proximaLinha) return;

    const primeiroInput = proximaLinha.querySelector('input:not([type="checkbox"])')
    
    if (primeiroInput) {
        primeiroInput.focus();
    }
}

function uploadPDF(input) {
    const id = input.dataset.id;
    const file = input.files[0];
    if (!file || !id) return;

    const formData = new FormData();
    formData.append("file", file);
    formData.append("id", id);

    fetch("/upload-pdf", {
        method: "POST",
        body: formData
    })
    .then(res => {
        if (!res.ok) throw new Error("Falha no upload");
        return res.json();
    })
    .then(() => {
        const td = input.closest("td");

        let link = td.querySelector(".pdf-link");
        if (!link) {
            link = document.createElement("a");
            link.className = "pdf-link";
            link.target = "_blank";
            td.prepend(link);
        }

        link.textContent = file.name;
        link.href = "#"; // URL real aparece ao recarregar

        alert("PDF enviado com sucesso");
    })
    .catch(err => {
        alert("Erro ao enviar PDF");
        console.error(err);
    });
}

document.addEventListener("input", function (e) {
    const input = e.target;
    if (input.tagName !== "INPUT") return;

    const tr = input.closest("tr");
    if (!tr || !tr.classList.contains("linha-nova")) return;

    // se o usuário começou a digitar
    if (input.value.trim() !== "" && !tr.dataset.criada) {
    tr.dataset.criada = "true";

    fetch("/criar-tarefa", { method: "POST" })
        .then(res => res.json())
        .then(data => {
            const id = data.id;

            // aplica o ID em TODOS os inputs da linha
            tr.querySelectorAll("input").forEach(inp => {
                inp.dataset.id = id;
            });

            tr.classList.remove("linha-nova");
            criarNovaLinha(); // cria a próxima vazia
        });
}
});

function criarNovaLinha() {
    const tbody = document.querySelector("tbody");

    const novaLinha = document.createElement("tr");
    novaLinha.classList.add("linha-nova");

    novaLinha.innerHTML = `
        <td><input type="checkbox"></td>

        <td><input type="text" data-coluna="Descrição"></td>
        <td><input type="text" data-coluna="Status"></td>
        <td><input type="date" data-coluna="Data"></td>
        <td><input type="text" data-coluna="Responsável"></td>
        <td><input type="text" data-coluna="Observações"></td>
        <td><input type="file"></td>
    `;

    tbody.appendChild(novaLinha);
}

</script>

</body>
</html>

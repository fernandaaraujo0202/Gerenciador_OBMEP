<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gerenciador de Tarefas</title>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            vertical-align: middle;
        }

        th { background-color: #f2f2f2; }

        .btn-upload {
            display: inline-block;
            padding: 4px 10px;
            margin-left: 8px;
            background: #eee;
            border: 1px solid #ccc;
            cursor: pointer;
            border-radius: 4px;
        }

        .pdf-link {
            margin-right: 8px;
            color: blue;
            text-decoration: underline;
        }
    </style>
</head>

<body>

<h2>Tabela de tarefas</h2>
<a href="/logout">Sair</a>

<div style="margin:10px 0">
    <button onclick="removerSelecionados()">üóëÔ∏è Remover</button>
</div>

<table>
<thead>
<tr>
    <th>Selecionar</th>
    <th>Descri√ß√£o</th>
    <th>Status</th>
    <th>Data</th>
    <th>Respons√°vel</th>
    <th>Observa√ß√µes</th>
    <th>Arquivo</th>
</tr>
</thead>

<tbody>

{% for tarefa in tarefas %}
<tr>
    <td><input type="checkbox" class="chk-remover" data-id="{{ tarefa.ID }}"></td>

    <td><input type="text" value="{{ tarefa.Descri√ß√£o or '' }}"
        data-id="{{ tarefa.ID }}" data-coluna="Descri√ß√£o"></td>

    <td>
        <select data-id="{{ tarefa.ID }}" data-coluna="Status">
            <option value="">-- selecione --</option>
            <option value="A fazer" {% if tarefa.Status=="A fazer" %}selected{% endif %}>A fazer</option>
            <option value="Em andamento" {% if tarefa.Status=="Em andamento" %}selected{% endif %}>Em andamento</option>
            <option value="Conclu√≠do" {% if tarefa.Status=="Conclu√≠do" %}selected{% endif %}>Conclu√≠do</option>
        </select>
    </td>

    <td><input type="date" value="{{ tarefa.Data or '' }}"
        data-id="{{ tarefa.ID }}" data-coluna="Data"></td>

    <td><input type="text" value="{{ tarefa.Respons√°vel or '' }}"
        data-id="{{ tarefa.ID }}" data-coluna="Respons√°vel"></td>

    <td><input type="text" value="{{ tarefa.Observa√ß√µes or '' }}"
        data-id="{{ tarefa.ID }}" data-coluna="Observa√ß√µes"></td>

    <td>
        {% if tarefa.PDF %}
            <a class="pdf-link" target="_blank"
               href="{{ tarefa.PDF }}">{{ tarefa.PDF.split('/')[-1] }}</a>
        {% else %}
            <span class="pdf-link">Nenhum arquivo</span>
        {% endif %}

        <label class="btn-upload">
            Escolher arquivo
            <input type="file" hidden
                   data-id="{{ tarefa.ID }}"
                   onchange="uploadPDF(this)">
        </label>
    </td>
</tr>
{% endfor %}

<!-- LINHA NOVA -->
<tr class="linha-nova">
    <td><input type="checkbox"></td>

    <td><input type="text" data-coluna="Descri√ß√£o"></td>

    <td>
        <select data-coluna="Status">
            <option value="">-- selecione --</option>
            <option>A fazer</option>
            <option>Em andamento</option>
            <option>Conclu√≠do</option>
        </select>
    </td>

    <td><input type="date" data-coluna="Data"></td>
    <td><input type="text" data-coluna="Respons√°vel"></td>
    <td><input type="text" data-coluna="Observa√ß√µes"></td>
    <td><input type="file" onchange="uploadPDF(this)"></td>
</tr>

</tbody>
</table>

<script>
/* ================== CRIA√á√ÉO AUTOM√ÅTICA ================== */
document.addEventListener("change", function (e) {
    const el = e.target;
    if (!["INPUT", "SELECT"].includes(el.tagName)) return;

    const tr = el.closest("tr");
    if (!tr || !tr.classList.contains("linha-nova")) return;

    if (el.value && !tr.dataset.criada) {
        tr.dataset.criada = "true";

        fetch("/criar-tarefa", { method: "POST" })
            .then(r => r.json())
            .then(data => {
                const id = data.id;

                tr.querySelectorAll("input, select")
                  .forEach(c => c.dataset.id = id);

                tr.classList.remove("linha-nova");

                salvarCampo(el);
                criarNovaLinha();
            });
    }
});

/* ================== SALVAR INPUT E SELECT ================== */
document.addEventListener("blur", e => {
    if (["INPUT", "SELECT"].includes(e.target.tagName)) {
        salvarCampo(e.target);
    }
}, true);

document.addEventListener("change", e => {
    if (e.target.tagName === "SELECT") {
        salvarCampo(e.target);
    }
});

function salvarCampo(el) {
    if (!el.dataset.id || !el.dataset.coluna) return;

    fetch("/atualizar-celula", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            id: Number(el.dataset.id),
            coluna: el.dataset.coluna,
            valor: el.value
        })
    }).then(() => {
        el.style.background = "#d4f8d4";
        setTimeout(() => el.style.background = "", 600);
    });
}

/* ================== UPLOAD PDF ================== */
function uploadPDF(input) {
    const id = input.dataset.id;
    if (!id || !input.files[0]) return;

    const fd = new FormData();
    fd.append("id", id);
    fd.append("file", input.files[0]);

    fetch("/upload-pdf", { method:"POST", body:fd })
        .then(() => location.reload());
}

/* ================== REMOVER ================== */
function removerSelecionados() {
    const ids = [...document.querySelectorAll(".chk-remover:checked")]
        .map(c => Number(c.dataset.id));

    if (!ids.length) return alert("Selecione uma linha");

    fetch("/remover-tarefas", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(ids)
    }).then(() => location.reload());
}

/* ================== NOVA LINHA ================== */
function criarNovaLinha() {
    const tr = document.createElement("tr");
    tr.className = "linha-nova";
    tr.innerHTML = `
        <td><input type="checkbox"></td>
        <td><input type="text" data-coluna="Descri√ß√£o"></td>
        <td>
            <select data-coluna="Status">
                <option value="">-- selecione --</option>
                <option>A fazer</option>
                <option>Em andamento</option>
                <option>Conclu√≠do</option>
            </select>
        </td>
        <td><input type="date" data-coluna="Data"></td>
        <td><input type="text" data-coluna="Respons√°vel"></td>
        <td><input type="text" data-coluna="Observa√ß√µes"></td>
        <td><input type="file" onchange="uploadPDF(this)"></td>
    `;
    document.querySelector("tbody").appendChild(tr);
}
</script>

</body>
</html>
